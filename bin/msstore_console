#! /usr/bin/env ruby

def metastore_banner
  banner = {}
  banner[:color] = "\e[34m"
  banner[:text] = <<-BANNER
 _______ _______ _______ _______ ______  _______ _       _______ 
(       )  ____ \\       )  ___  )  __  \\(  ____ \\ \\     (  ____ \\
| () () | (    \\/ () () | (   ) | (  \\  ) (    \\/ (     | (    \\/
| || || | (__   | || || | |   | | |   ) | (__   | |     | (_____ 
| |(_)| |  __)  | |(_)| | |   | | |   | |  __)  | |     (_____  )
| |   | | (     | |   | | |   | | |   ) | (     | |           ) |
| )   ( | )     | )   ( | (___) | (__/  ) (____/\\ (____/Y\\____) |
|/     \\|/      |/     \\|_______)______/(_______/_______|_______)
BANNER
  banner
end

def db_info_file
  hidden_file = "#{Dir.home}/.msf_models.yml"
  if File.readable?(hidden_file)
    pro_path = YAML.load_file(hidden_file)['pro_path']
    return "#{pro_path}/ui/config/database.yml"
  elsif !ARGV[0].blank?
    return ARGV[0]
  else
    warn "No YAML file of DB info available"
    exit
  end
end

begin
  require 'pry'
  require "msf_models"

  # Set up a DB connection, preferring one from Pro if it's in the normal place
  # Otherwise get from ARGV[0]

  if File.readable?(db_info_file)
    connection_info = YAML.load_file(db_info_file)
    ActiveRecord::Base.establish_connection(connection_info['development'])
  else
    warn "Can't access DB -- check file path."
    exit
  end

  include MsfModels
  MsfModels.create_and_load_ar_classes


  puts "\n\n\n#{metastore_banner[:color]}#{metastore_banner[:text]}\e[0m\n\n\n"

  Pry.config.prompt = proc { |obj, nest_level, _| "msstore:#{nest_level}> " }

  Pry.start
  exit
rescue LoadError
  warn "Unable to load Pry"
end

