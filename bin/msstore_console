#! /usr/bin/env ruby

def metastore_banner
  banner = {}
  banner[:color] = "\e[34m"
  banner[:text] = <<-BANNER
                           mm                      mm                           
                           MM                      MM                           
`7MMpMMMb.pMMMb.  .gP"Ya mmMMmm  ,6"Yb.  ,pP"Ybd mmMMmm ,pW"Wq.`7Mb,od8 .gP"Ya  
  MM    MM    MM ,M'   Yb  MM   8)   MM  8I   `"   MM  6W'   `Wb MM' "',M'   Yb 
  MM    MM    MM 8M""""""  MM    ,pm9MM  `YMMMa.   MM  8M     M8 MM    8M"""""" 
  MM    MM    MM YM.    ,  MM   8M   MM  L.   I8   MM  YA.   ,A9 MM    YM.    , 
.JMML  JMML  JMML.`Mbmmd'  `Mbmo`Moo9^Yo.M9mmmP'   `Mbmo`Ybmd9'.JMML.   `Mbmmd' 
BANNER
  banner
end

def db_info_file
  hidden_file = "#{Dir.home}/.msf_models.yml"
  if File.readable?(hidden_file)
    pro_path = YAML.load_file(hidden_file)['pro_path']
    return "#{pro_path}/ui/config/database.yml"
  elsif !ARGV[0].blank?
    return ARGV[0]
  else
    warn "No YAML file of DB info available"
    exit
  end
end

begin
  require 'pry'
  require "msf_models"


  # Set up a DB connection, preferring one from Pro if it's in the normal place
  # Otherwise get from ARGV[0]

  if File.readable?(db_info_file)
    connection_info = YAML.load_file(db_info_file)
    ActiveRecord::Base.establish_connection(connection_info['development'])
  else
    warn "Can't access DB -- check file path."
    exit
  end

  include MsfModels
  MsfModels.create_and_load_ar_classes


  puts "\n\n\n#{metastore_banner[:color]}#{metastore_banner[:text]}\e[0m\n\n\n"

  Pry.config.prompt = proc { |obj, nest_level, _| "msstore:#{nest_level}> " }

  Pry.start
  exit
rescue LoadError
  warn "Unable to load Pry"
end

